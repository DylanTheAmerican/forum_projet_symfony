{% extends 'base.html.twig' %}

{% block title %}{{ topic.title }}{% endblock %}

{% block body %}
    <h1>Forum</h1>
    <h2>{{ topic.title }}</h2>
    <a href="{{ path('category-bySlug', {slug: topic.category.slug}) }}" class="badge bg-primary">{{ topic.category.title }}</a>
    <small class="text-black-50">{{ topic.publishedDate|date }}</small>
    <p class="mt-3">{{ topic.content }}</p>
    <div class="mt-2">Auteur : <a href="{{ path('author-bySlug', {slug: topic.author.slug}) }}">{{ topic.author.firstname }} {{ topic.author.lastname }}</a></div>

    {% if app.user %}
        <a href="{{ path('topic-editById', {id: topic.id}) }}" class="btn btn-warning btn-lg">Editer</a>
    {% endif %}
    <div class="mt-5">
        <h3>Commentaires</h3>

        {% if app.user %}
            <div class="card mb-3">
                <div class="card-header">
                    Ajouter une réponse
                </div>
                <div class="card-body">
                    {{ form_start(postAnswerForm) }}
                        <input type="hidden" name="parent_post_comment_id" value="0" />
                        {{ form_row(postAnswerForm.title) }}
                        {{ form_row(postAnswerForm.content) }}

                        <button type="submit" class="btn btn-outline-primary btn-submit">Ajouter un commenter</button>
                        <button type="submit" class="btn btn-outline-primary btn-reply-submit">Répondre au commentaire</button>
                    {{ form_end(postAnswerForm) }}
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">Veuillez vous connecter pour envoyer un commentaire.</div>
        {% endif %}

        {% for answer in answers %}
            <div class="card mb-3">
                <div class="card-header">{{ answer.title }}</div>
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p>{{ answer.content }}</p>
                        <footer class="blockquote-footer mt-3">{{ answer.date|date('d/m/Y H:i') }} <cite title="{{ answer.author.firstname }} {{ answer.author.lastname }}">{{ answer.author.firstname }} {{ answer.author.lastname }}</cite></footer>
                    </blockquote>

                    {% if app.user %}
                        <button type="button" data-comment-id="{{ answer.id }}" class="btn mt-3 btn-outline-secondary btn-reply">Répondre</button>
                    {% endif %}
                    {% if answer.replies|length > 0 %}
                        <div class="mt-3">
                            <h4>Réponses</h4>
                            {% for reply in answer.replies %}
                                <div class="card mb-3">
                                    <div class="card-header">{{ reply.title }}</div>
                                    <div class="card-body">
                                        <blockquote class="blockquote mb-0">
                                            <p>{{ reply.content }}</p>
                                            <footer class="blockquote-footer mt-3">{{ reply.date|date('d/m/Y H:i') }} <cite title="{{ reply.author.firstname }} {{ reply.author.lastname }}">{{ reply.author.firstname }} {{ reply.author.lastname }}</cite></footer>
                                        </blockquote>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(document).ready(function() {
            var $parentPostComment = $('input[name=parent_post_comment_id]'),
                $btnSubmit = $('.btn-submit'),
                $btnReplySubmit = $('.btn-reply-submit');

            $btnSubmit.hide();
            $('.btn-reply').on('click', function(event) {
                event.preventDefault();
                $parentPostComment.val($(this).attr('data-comment-id'));
                $btnSubmit.hide();
                $btnReplySubmit.show();
            });
        })
    </script>
{% endblock %}